<% content_for(:title, "#{@fund.name} â€” Investments Portfolio") %>

<div class="mb-4">
  <%= link_to "&larr; Back to Funds".html_safe, funds_path, class: "text-indigo-600 hover:text-indigo-800 text-sm" %>
</div>

<h1 class="text-2xl font-bold text-gray-800 mb-1"><%= @fund.name %></h1>
<p class="text-sm text-gray-500 mb-6">ISIN: <%= @fund.isin %> &middot; Ticker: <%= @fund.yahoo_ticker %></p>

<% nav = @fund.latest_nav %>
<% if nav %>
  <div class="grid grid-cols-3 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-500">Latest NAV</p>
      <p class="text-2xl font-bold"><%= format_euro(nav.nav) %></p>
      <p class="text-xs text-gray-400"><%= nav.price_date.strftime("%d/%m/%Y") %></p>
    </div>
    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-500">Daily Change</p>
      <p class="text-xl font-bold <%= gain_color(nav.daily_change) %>">
        <% if nav.daily_change %>
          <%= gain_sign(nav.daily_change) %><%= format_euro(nav.daily_change) %>
          (<%= gain_sign(nav.daily_change_pct) %><%= format_pct(nav.daily_change_pct) %>)
        <% else %>
          ---
        <% end %>
      </p>
    </div>
    <div class="bg-white rounded-xl shadow p-5">
      <p class="text-sm text-gray-500">Target Allocation</p>
      <p class="text-2xl font-bold text-indigo-600"><%= format_pct(@fund.allocation_pct) %></p>
    </div>
  </div>
<% end %>

<!-- NAV Chart -->
<div class="bg-white rounded-xl shadow p-5 mb-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold text-gray-800">NAV History</h2>
    <div class="flex space-x-1">
      <% %w[1M 3M 6M YTD 1Y 3Y ALL].each do |period| %>
        <% active = period == @period %>
        <% css = active ? "bg-indigo-600 text-white" : "bg-white text-gray-700 hover:bg-gray-100" %>
        <%= link_to period, fund_path(@fund, period: period), class: "px-3 py-1 rounded-md text-sm font-medium #{css}" %>
      <% end %>
    </div>
  </div>
  <% if @nav_data.any? %>
    <%= line_chart @nav_data, prefix: "\u20AC", thousands: ".", decimal: ",", discrete: true, library: { scales: { y: { beginAtZero: false } } } %>
  <% else %>
    <p class="text-gray-400 text-center py-12">No NAV data for this period.</p>
  <% end %>
</div>

<!-- Holdings per Policy -->
<% if @holdings.any? %>
  <div class="bg-white rounded-xl shadow p-5">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Holdings by Policy</h2>
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-gray-500 border-b">
          <th class="pb-2">Policy</th>
          <th class="pb-2 text-right">Units</th>
          <th class="pb-2 text-right">Value</th>
          <th class="pb-2 text-right">As of</th>
        </tr>
      </thead>
      <tbody>
        <% @holdings.each do |holding| %>
          <tr class="border-b border-gray-100">
            <td class="py-2">
              <%= link_to holding.policy.name, policy_path(holding.policy.slug), class: "text-indigo-600 hover:text-indigo-800" %>
            </td>
            <td class="py-2 text-right font-mono"><%= number_with_precision(holding.units, precision: 6) %></td>
            <td class="py-2 text-right font-medium"><%= format_euro(holding.current_value) %></td>
            <td class="py-2 text-right text-gray-500"><%= holding.units_as_of_date&.strftime("%d/%m/%Y") || "---" %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>
